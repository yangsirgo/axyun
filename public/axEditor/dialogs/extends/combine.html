<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>文本元素</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta name="generator" content="" />
    <link rel="stylesheet" href="css/ax.dialog.css" />
    <link rel="stylesheet" href="../../third-party/jquery-ui.min.css" />
    <link rel="stylesheet" href="../../third-party/pages/pagination.css" />
    <style>
      .cascade-table th,
      .cascade-table td {
        word-break: keep-all;
      }
      table.cascade-table tr td {
        width: auto;
        height: auto;
        line-height: 1.5;
        text-align: center;
        word-break: break-all;
      }
      table.cascade-table tr td.left {
        text-align: left;
      }
      .setting-box label {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="content">
      <div class="well well-tooltip" id="tooltip">
        <table class="tooltip-table">
          <tr>
            <td class="first-td">定义</td>
            <td id="tooltipDefine" class="second-td"></td>
          </tr>
          <tr id="valueDomain">
            <td class="first-td">允许值域</td>
            <td class="second-td">
              <table id="tooltipValueDomain" class="tooltip-table" border="1">
                <tr>
                  <th>值</th>
                  <th>值含义</th>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </div>
      <form id="combieleForm" class="text-form">
        <fieldset>
          <legend>基本属性</legend>
          <table>
            <tr>
              <td id="tooltipPoint">数据元</td>
              <td>
                <input
                  type="text"
                  id="metaData"
                  style="width:170px;margin-right: 10px;"
                /><img
                  title="列表查询"
                  style="vertical-align: -5px;cursor:pointer;"
                  src="images/search.png"
                  id="showMore"
                />
                <input type="hidden" id="metaDataId" />
                <input type="hidden" name="metaData" id="metaDataInfo" />
              </td>
              <!-- </tr>
                <tr> -->
              <td>元素编码</td>
              <td>
                <input
                  type="text"
                  autocomplete="off"
                  name="id"
                  id="id"
                  autocomplete="off"
                  readonly
                />
              </td>
            </tr>
            <tr>
              <td>元素名称</td>
              <td>
                <input
                  type="text"
                  autocomplete="off"
                  name="name"
                  autocomplete="off"
                  id="name"
                />
              </td>
              <!-- </tr>
                <tr> -->
              <td>占位文本</td>
              <td>
                <input
                  type="text"
                  autocomplete="off"
                  name="placeholderText"
                  autocomplete="off"
                  id="placeholderText"
                />
              </td>
            </tr>
            <tr id="defaultValTr">
              <td>提示文本</td>
              <td>
                <input
                  type="text"
                  autocomplete="off"
                  name="tipText"
                  autocomplete="off"
                  id="tipText"
                />
              </td>
              <!-- </tr> -->
              <!-- <tr>
                    <td>前缀</td>
                    <td><input type="text" autocomplete="off" name="prefix"></td>
                    <td>后缀</td>
                    <td><input type="text" autocomplete="off" name="suffix"></td>
                </tr> -->
              <!-- <tr id="defaultValTr"> -->
              <td>默认值</td>
              <td colspan="3">
                <input
                  type="text"
                  autocomplete="off"
                  name="defaultVal"
                  id="defaultVal"
                />
              </td>
            </tr>
          </table>
        </fieldset>
        <fieldset>
          <legend>勾选属性</legend>
          <ul class="checkSettings">
            <li>
              <input type="checkbox" name="readonly" id="readonly" />
              <label for="readonly">只读</label>
            </li>
            <li>
              <input type="checkbox" name="isSecret" id="isSecret" />
              <label for="isSecret">保密</label>
            </li>
            <li>
              <input type="checkbox" name="isDel" id="isDel" checked />
              <label for="isDel">可删除</label>
            </li>
            <!-- <li>
                    <input type="checkbox" name="showBorder" id="showBorder" checked>
                    <label for="showBorder">显示边框</label>
                </li> -->
            <li>
              <input type="checkbox" name="isHide" id="isHide" />
              <label for="isHide">隐藏</label>
            </li>
            <li>
              <input type="checkbox" name="quot" id="quot" />
              <label for="quot">引用</label>
            </li>
            <li>
              <input type="checkbox" name="source" id="source" />
              <label for="source">源</label>
            </li>
            <li>
              <input type="checkbox" name="isEmpty" id="isEmpty" checked />
              <label for="isEmpty">可为空</label>
            </li>
            <li>
              <input type="checkbox" name="isPrint" id="isPrint" checked />
              <label for="isPrint">可打印</label>
            </li>
            <li>
              <input type="checkbox" name="checkDirectCite" id="checkDirectCite" checked />
              <label for="checkDirectCite">直接引用</label>
            </li>
          </ul>
        </fieldset>
        <fieldset>
          <legend>边框设置</legend>
          <div>
            <span class="label">显示类型: </span>
            <input
              type="radio"
              name="borderType"
              id="underline"
              value="underline"
            />
            <label for="underline">下划线</label>
            <input type="radio" name="borderType" id="border" value="border" 
            checked/>
            <label for="border">边框</label>
            <input type="radio" name="borderType" id="border" value="none" />
            <label for="none">隐藏</label>
          </div>
          <div id="borderType">
            <span class="label">边框类型: </span>
            <select
              name="borderStyle"
              id="borderStyle"
              class="borderStyle"
              style="width: 100px;"
            >
              <option value="0" selected>[]</option>
              <option value="1">{}</option>
              <option value="2">“”</option>
            </select>
          </div>
          <div id="borderHolder">
            <label for="stainholder">边框是否占位</label>
            <input type="checkbox" name="stainholder" id="stainholder" />
          </div>
        </fieldset>
        <fieldset id="insertPart">
          <legend>专有属性</legend>
          <span class="setting-box setting-box-zhuanyou setting-box-zhuanyou1">
            级联设置按钮：
            <button id="cascadesetter" type="button">级联设置</button>
          </span>
        </fieldset>
        <fieldset id="showCascade">
          <legend>级联效果展现</legend>
          <table class="cascade-table border">
            <thead>
              <tr>
                <th width="48">序列</th>
                <th width="93">条件项</th>
                <th width="68">条件</th>
                <th width="93">触发值</th>
                <th width="70">结果</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr>
                <td colspan="5" style="text-align: center">空</td>
              </tr>
            </tbody>
          </table>
        </fieldset>
      </form>
    </div>
    <script src="../../third-party/jquery-1.10.2.min.js"></script>
    <script src="../../third-party/jquery-ui.min.js"></script>
    <script src="../../third-party/pages/pagination.min.js"></script>
    <script src="../../third-party/tooltip/jquery.popupoverlay.js"></script>
    <script src="../internal.js"></script>
    <script src="js/baseElement.js"></script>
    <script type="text/javascript">
      var formName = "combieleForm",
        thePlugins = "combine",
        pluginCode = "09";
      $("#cascadesetter").click(function() {
        editor.execCommand("cascadesetter");
        return false;
      });
      setTimeout(function() {
        initDisplayTable();
      }, 100);

      // $("#tbody").
      function initDisplayTable() {
        if (AX.plugins[thePlugins].editdom) {
          oNode = AX.plugins[thePlugins].editdom;
          // console.log(oNode);
          var html = "";
          var saveValueStr = oNode.getAttribute("cascadesetdata");
          if (saveValueStr != null) {
            // debugger
            var saveValueList = JSON.parse(saveValueStr);
            $.each(saveValueList, function(index, item) {
              var setting = item.setting;
              var nameList = item.eleNameObj;
              var resultStr =
                "显示：" +
                nameList.showNameList.toString() +
                ";<br />隐藏：" +
                nameList.hideNameList.toString(); //结果字符串
              html +=
                "<tr><td>" +
                (index + 1) +
                '</td><td class="left">' +
                setting.cascadeIdText +
                "</td><td>" +
                setting.operatorText +
                "</td><td>" +
                setting.showConditionText +
                '</td><td class="left">' +
                resultStr +
                "</td></tr>";
            });
          } else {
            html =
              '<tr><td colspan="5"   style="text-align: center">空</td></tr>';
          }
          $("#tbody").html(html);
        }
      }

      var oNode = AX.plugins[thePlugins].editdom;
      dialog.onok = function() {
        var json = $("#" + formName).serializeJson();

        if (json.id == "") {
          alert("请输入元素编码");
          return false;
        }
        if (json.name == "") {
          alert("请输入元素名称");
          return false;
        }

        if (!oNode) {
          try {
            var html = makeHtml(json);
            oNode = createElement("span", json.id);
            oNode.setAttribute("contenteditable", "false");
            oNode.setAttribute("class", "ctrl-bg ctrl-field combine-bg");
            oNode.setAttribute("axPlugins", thePlugins);
            setAttrs(oNode, json);
            oNode.innerHTML = html;

            editor.execCommand(
              "insertHtml",
              "\u200B" + oNode.outerHTML + "\u200B"
            );
          } catch (e) {
            try {
              console.log(e);
              editor.execCommand("error");
            } catch (e) {
              alert("控件异常，请联系 [安想智慧医疗] 管理员！");
            }
            return false;
          }
        } else {
          // var cascadesetdata = oNode.getAttribute('cascadesetdata');
          // var cascadeId_ = oNode.getAttribute('cascadeId_');
          // var showcondition = oNode.getAttribute('showcondition');
          // var cascadestate = oNode.getAttribute('cascadestate');
          var innerHtml = $(oNode)
            .find(".ctrl-value")
            .html();
          var html = makeHtml(json);
          // html.innerHTML = innerHtml;
          oNode.setAttribute("id", json.id);
          setAttrs(oNode, json);
          oNode.innerHTML = html;
          oNode.children[0].innerHTML = innerHtml;
          delete AX.plugins[thePlugins].editdom;
        }
      };

      /**
       * 设置dom节点属性
       * @param {DOM} node 节点
       * @param {Object} json json属性
       * @returns {Null} nul
       */
      function setAttrs(node, json) {
        node.setAttribute("title", json.tipText);
        node.setAttribute("isSecret", !!json.isSecret);

        //组合元素 显示边框是 {} 做个判断
        if (thePlugins === "combine") {
          node.setAttribute("start-stain", json.showBorder ? "{" : "");
          node.setAttribute("end-stain", json.showBorder ? "}" : "");
        } else {
          node.setAttribute("start-stain", json.showBorder ? "[" : "");
          node.setAttribute("end-stain", json.showBorder ? "]" : "");
        }
        var nodeClass = node.getAttribute("class");
        if (json.showBorder) {
          node.setAttribute(
            "class",
            nodeClass ? nodeClass.replace(" no-border", "") : ""
          );
        } else {
          node.setAttribute(
            "class",
            nodeClass ? nodeClass + " no-border" : " no-border"
          );
        }
        node.setAttribute("cascadeId", json.cascadeId);
        node.setAttribute("showCondition", json.showCondition);
        node.setAttribute("attrs", JSON.stringify(json));
      }

      /**
       * 构造控件html
       * @param {Object} json 控件属性json
       * @returns {String} 控件html
       */
      function makeHtml(json) {
        var currText = oNode && $.trim(oNode.innerText).replace(/\u200B/g, ""); //获取text，并删除空白字符&#8203;;
        var defaultVal = json.defaultVal === undefined ? "" : json.defaultVal;
        if (thePlugins === "numberelement") {
          //数字元素插入单位和默认值，与其他元素不一样
          currText = ""; //数字元素编辑回弹窗 不取oNode 的值。
          if (
            $("#eleUnitContr").attr("checked") === "checked" &&
            json.elemUnit
          ) {
            var elemUnit = json.elemUnit.split("、")[0];
            defaultVal =
              '<span type="numVal">' +
              defaultVal +
              '</span><span type="eleUnitVal">' +
              elemUnit +
              "</span>";
          }
        }
        var innerText = currText ? currText : defaultVal;
        //针对select 和 selectmulti 元素 显示默认值的情况
        if (thePlugins === "select" || thePlugins === "selectmulti") {
          var selectVal;
          var selectValList = [];
          var allData = getTableData();
          selectValList = json.userDefault
            ? unique(json.userDefault.cleanEmptyItem())
            : []; //数组去重 去空
          innerText = getValueListByKey(selectValList, allData).toString();
        }
        //用户输入的自由文本有 span 包裹  并有 class="_textnode_" id=时间戳
        // var innerSpan = '<span class="_textnode_" id="' + (+ new Date()) + '" placeholder="' + json.placeholderText + '">' + innerText + '</span>';

        var html =
          '<span title="' +
          json.tipText +
          '" secret-value="' +
          !!json.isSecret +
          '" class="ctrl-value" placeholder="' +
          json.placeholderText +
          '" >' +
          innerText +
          "</span>";
        return html;
      }
    </script>
  </body>
</html>
